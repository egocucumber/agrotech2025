# РУКОВОДСТВО СИСТЕМНОГО ПРОГРАММИСТА

## 1. ОБЩИЕ СВЕДЕНИЯ О ПРОГРАММЕ

### 1.1. Назначение и функции программы

Программа AgroVzor предназначена для автоматизации и мониторинга процесса трехзвенной уборки урожая зерновых культур. Система обеспечивает автоматизированное взаимодействие между комбайном, бункером-перегрузчиком и зерновозом, осуществляет учет и контроль перемещения зерна, анализирует потери урожая, мониторит состояние техники и эффективность работы механизаторов.

**Основные функции:**
- Управление организационной структурой (предприятия, сотрудники, техника)
- Планирование и учет полевых работ
- Сбор и обработка телеметрических данных
- Аналитика и мониторинг (потери зерна, вибрация, топливо, эффективность)
- Визуализация данных и формирование отчетов

### 1.2. Технические средства

**Серверная часть:**
- Процессор: 2 ядра, 2.0 GHz (минимально), 4 ядра, 2.5 GHz (рекомендуется)
- Оперативная память: 2 GB (минимально), 4-8 GB (рекомендуется)
- Свободное место на диске: 10 GB (минимально), 50 GB (рекомендуется, SSD)
- Сетевая карта: 100 Мбит/с (минимально), 1 Гбит/с (рекомендуется)
- Операционная система: Linux, Windows Server, macOS (для разработки)

**База данных:**
- PostgreSQL версии 16 или выше
- Минимальные требования: 1 GB RAM, 20 GB дискового пространства
- Рекомендуемые требования: 4 GB RAM, 100 GB дискового пространства (SSD)

### 1.3. Программные средства

**Серверная часть:**
- Java Runtime Environment версии 17 или выше
- Spring Boot Framework версии 4.0.0
- Spring Data JPA
- PostgreSQL версии 16 или выше
- Docker и Docker Compose (для контейнеризации)
- Gradle версии 8.4 или выше (для сборки)

**Клиентская часть:**
- Node.js версии 20 или выше
- Next.js Framework версии 16.0.3
- React версии 19.2.0
- TypeScript версии 5 или выше

## 2. СТРУКТУРА ПРОГРАММЫ

### 2.1. Архитектура системы

Программа реализует клиент-серверную архитектуру:

```
┌─────────────────┐
│  Веб-браузер    │
│   (Frontend)    │
└────────┬────────┘
         │ HTTP/HTTPS
         │
┌────────▼────────┐
│  Spring Boot    │
│   (Backend)     │
└────────┬────────┘
         │ JDBC
         │
┌────────▼────────┐
│   PostgreSQL    │
│   (Database)    │
└─────────────────┘
```

### 2.2. Составные части серверной части

**Пакет ru.feryafox.agrovzorback:**

- **AgroVzorApplication.java** - главный класс приложения, точка входа
- **config/** - конфигурационные классы (CORS, OpenAPI, Web)
- **entity/** - JPA сущности (модель данных)
- **repository/** - Spring Data JPA репозитории
- **service/** - бизнес-логика
- **controller/** - REST API контроллеры
- **dto/** - Data Transfer Objects
- **mapper/** - мапперы для преобразования Entity <-> DTO

### 2.3. Составные части клиентской части

**Структура Next.js приложения:**

- **app/** - страницы Next.js (App Router)
- **components/** - React компоненты
  - **ui/** - базовые UI компоненты
  - **charts/** - компоненты графиков
  - **maps/** - компоненты карт
- **lib/** - вспомогательные модули
  - **api.ts** - клиент API
  - **types.ts** - TypeScript типы
  - **utils.ts** - утилитарные функции

### 2.4. Связи между составными частями

- Контроллеры получают HTTP-запросы и вызывают методы сервисов
- Сервисы используют репозитории для доступа к данным
- Сервисы применяют мапперы для преобразования Entity в DTO
- Контроллеры возвращают DTO клиенту в формате JSON
- Клиентская часть отправляет HTTP-запросы к REST API
- Клиентская часть отображает данные в веб-интерфейсе

### 2.5. Связи с другими программами

- **PostgreSQL:** Хранение всех данных через JDBC и Spring Data JPA
- **Веб-браузер:** Отображение клиентской части
- **Бортовые модули:** Прием данных через HTTP REST API
- **ФГИС «Зерно»:** Интеграция для автоматической отчетности (планируется)
- **ERP-системы:** Интеграция через REST API (планируется)

## 3. НАСТРОЙКА ПРОГРАММЫ

### 3.1. Установка серверной части

**3.1.1. Установка через Docker Compose (рекомендуемый способ):**

1. Убедитесь, что установлены Docker и Docker Compose
2. Скопируйте файлы проекта в рабочую директорию
3. Откройте терминал в директории проекта
4. Выполните команду:
   ```bash
   docker-compose up --build
   ```
5. Дождитесь запуска контейнеров (PostgreSQL и Spring Boot приложение)

**3.1.2. Локальная установка:**

1. Установите Java 17 или выше
2. Установите PostgreSQL 16 или выше
3. Создайте базу данных:
   ```sql
   CREATE DATABASE agrovzor;
   CREATE USER agrovzor WITH PASSWORD 'agrovzor';
   GRANT ALL PRIVILEGES ON DATABASE agrovzor TO agrovzor;
   ```
4. Настройте файл `src/main/resources/application.properties`:
   ```properties
   spring.datasource.url=jdbc:postgresql://localhost:5432/agrovzor
   spring.datasource.username=agrovzor
   spring.datasource.password=agrovzor
   ```
5. Соберите проект:
   ```bash
   ./gradlew build
   ```
6. Запустите приложение:
   ```bash
   ./gradlew bootRun
   ```

### 3.2. Установка клиентской части

1. Установите Node.js 20 или выше
2. Откройте терминал в директории `AgroVzorFront`
3. Установите зависимости:
   ```bash
   npm install
   ```
4. Настройте переменные окружения (создайте файл `.env.local`):
   ```
   NEXT_PUBLIC_API_URL=http://localhost:8080/api
   ```
5. Запустите в режиме разработки:
   ```bash
   npm run dev
   ```
6. Или соберите для продакшена:
   ```bash
   npm run build
   npm start
   ```

### 3.3. Настройка базы данных

База данных создается автоматически при первом запуске приложения через Hibernate. Схема обновляется автоматически при изменении сущностей (режим `update`).

Для ручной настройки:
1. Подключитесь к PostgreSQL
2. Создайте базу данных и пользователя (см. раздел 3.1.2)
3. Настройте параметры подключения в `application.properties`

### 3.4. Настройка конфигурации

**Основные параметры в application.properties:**

```properties
# Название приложения
spring.application.name=AgroVzor

# Настройки базы данных
spring.datasource.url=jdbc:postgresql://localhost:5432/agrovzor
spring.datasource.username=agrovzor
spring.datasource.password=agrovzor
spring.datasource.driver-class-name=org.postgresql.Driver

# Настройки JPA
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

# Порт сервера
server.port=8080

# Настройки Swagger/OpenAPI
springdoc.api-docs.path=/api-docs
springdoc.swagger-ui.path=/swagger-ui.html
```

### 3.5. Настройка на состав технических средств

**Для увеличения производительности:**

1. Увеличьте объем оперативной памяти JVM:
   ```bash
   java -Xmx4g -jar agrovzor-back.jar
   ```

2. Настройте пул соединений к БД в `application.properties`:
   ```properties
   spring.datasource.hikari.maximum-pool-size=20
   spring.datasource.hikari.minimum-idle=5
   ```

3. Настройте параметры PostgreSQL в `postgresql.conf`:
   ```
   shared_buffers = 256MB
   effective_cache_size = 1GB
   maintenance_work_mem = 64MB
   ```

### 3.6. Выбор функций

Все функции включены по умолчанию. Для отключения отдельных функций можно:

1. Закомментировать соответствующие контроллеры
2. Настроить через конфигурационные файлы
3. Использовать feature flags (при реализации)

## 4. ПРОВЕРКА ПРОГРАММЫ

### 4.1. Контрольные примеры

**4.1.1. Проверка работы API:**

1. Откройте браузер и перейдите на `http://localhost:8080/swagger-ui.html`
2. Проверьте доступность всех endpoints
3. Выполните тестовые запросы через Swagger UI

**4.1.2. Проверка создания предприятия:**

```bash
curl -X POST http://localhost:8080/api/companies \
  -H "Content-Type: application/json" \
  -d '{
    "fullName": "Тестовое предприятие",
    "shortName": "Тест"
  }'
```

Ожидаемый результат: JSON с созданным предприятием и присвоенным UUID.

**4.1.3. Проверка получения списка предприятий:**

```bash
curl http://localhost:8080/api/companies
```

Ожидаемый результат: JSON массив со списком предприятий.

**4.1.4. Проверка работы базы данных:**

1. Подключитесь к PostgreSQL:
   ```bash
   psql -U agrovzor -d agrovzor
   ```
2. Выполните запрос:
   ```sql
   SELECT * FROM companies;
   ```
3. Проверьте наличие данных

### 4.2. Методы прогона

**4.2.1. Автоматизированное тестирование:**

1. Запустите unit-тесты:
   ```bash
   ./gradlew test
   ```

2. Запустите интеграционные тесты (при наличии)

**4.2.2. Ручное тестирование:**

1. Используйте Swagger UI для тестирования API
2. Используйте веб-интерфейс для проверки функциональности
3. Проверьте логи приложения на наличие ошибок

### 4.3. Результаты проверки

**При успешной проверке:**
- Все endpoints отвечают на запросы
- Данные сохраняются в базе данных
- Веб-интерфейс открывается и работает корректно
- Логи не содержат критических ошибок

**При обнаружении проблем:**
- Проверьте логи приложения
- Проверьте подключение к базе данных
- Проверьте конфигурационные файлы
- Обратитесь к разделу "Сообщения системному программисту"

## 5. ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ

### 5.1. Мониторинг и логирование

**Просмотр логов:**

1. Логи Spring Boot приложения выводятся в консоль
2. Для сохранения логов в файл настройте `logback.xml`:
   ```xml
   <appender name="FILE" class="ch.qos.logback.core.FileAppender">
     <file>logs/agrovzor.log</file>
     <encoder>
       <pattern>%d{yyyy-MM-dd HH:mm:ss} - %msg%n</pattern>
     </encoder>
   </appender>
   ```

**Мониторинг производительности:**

1. Используйте Spring Boot Actuator (при подключении):
   ```properties
   management.endpoints.web.exposure.include=health,metrics,info
   ```
2. Доступ к метрикам: `http://localhost:8080/actuator/metrics`

### 5.2. Резервное копирование

**Автоматическое резервное копирование PostgreSQL:**

1. Настройте cron-задачу для ежедневного бэкапа:
   ```bash
   0 2 * * * pg_dump -U agrovzor agrovzor > /backup/agrovzor_$(date +\%Y\%m\%d).sql
   ```

2. Или используйте pg_dump через Docker:
   ```bash
   docker exec postgres pg_dump -U agrovzor agrovzor > backup.sql
   ```

### 5.3. Масштабирование

**Горизонтальное масштабирование:**

1. Запустите несколько экземпляров приложения
2. Используйте балансировщик нагрузки (nginx, HAProxy)
3. Настройте сессии через Redis (при необходимости)

**Вертикальное масштабирование:**

1. Увеличьте ресурсы сервера (CPU, RAM, диск)
2. Настройте параметры JVM и PostgreSQL
3. Оптимизируйте запросы к базе данных

## 6. СООБЩЕНИЯ СИСТЕМНОМУ ПРОГРАММИСТУ

### 6.1. Сообщения при настройке

**Ошибка подключения к базе данных:**
```
ERROR: Unable to connect to database
```
**Действия:** Проверьте настройки подключения в `application.properties`, убедитесь, что PostgreSQL запущен и доступен.

**Ошибка создания таблиц:**
```
ERROR: Table already exists
```
**Действия:** Проверьте режим `ddl-auto` в настройках, при необходимости измените на `update` или `create`.

**Ошибка порта:**
```
ERROR: Port 8080 is already in use
```
**Действия:** Измените порт в `application.properties` или освободите порт 8080.

### 6.2. Сообщения при проверке

**Предупреждение о медленных запросах:**
```
WARN: Slow query detected (> 1 second)
```
**Действия:** Проверьте индексы в базе данных, оптимизируйте запросы.

**Ошибка нехватки памяти:**
```
ERROR: OutOfMemoryError
```
**Действия:** Увеличьте объем памяти JVM через параметр `-Xmx`.

### 6.3. Сообщения в ходе выполнения программы

**Ошибка подключения к базе данных:**
```
ERROR: Connection to database lost
```
**Действия:** Проверьте доступность PostgreSQL, перезапустите приложение.

**Предупреждение о высокой нагрузке:**
```
WARN: High CPU usage detected
```
**Действия:** Проверьте нагрузку на систему, рассмотрите возможность масштабирования.

**Ошибка дискового пространства:**
```
ERROR: Disk space is running low
```
**Действия:** Освободите место на диске, настройте ротацию логов.

### 6.4. Действия при критических ошибках

1. Проверьте логи приложения
2. Проверьте состояние базы данных
3. Проверьте доступность сетевых ресурсов
4. Перезапустите приложение
5. При необходимости восстановите из резервной копии
6. Обратитесь в техническую поддержку

## ПРИЛОЖЕНИЯ

**Приложение А. Примеры конфигурационных файлов**

Содержит примеры настройки различных компонентов системы.

**Приложение Б. Скрипты для автоматизации**

Содержит скрипты для резервного копирования, мониторинга, развертывания.

**Приложение В. Диаграммы архитектуры**

Содержит подробные диаграммы архитектуры системы и взаимодействия компонентов.

